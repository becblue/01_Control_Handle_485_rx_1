#include "oled.h"

/* OLED初始化命令数组 */
static const uint8_t OLED_Init_CMD[] = {
    0xAE,   // 关闭显示
    0xD5,   // 设置显示时钟分频比/振荡器频率
    0x80,   // 设置分频比
    0xA8,   // 设置多路复用率
    0x3F,   // 1/64 duty
    0xD3,   // 设置显示偏移
    0x00,   // 偏移量为0
    0x40,   // 设置显示开始行
    0x8D,   // 电荷泵设置
    0x14,   // 使能电荷泵
    0x20,   // 设置内存寻址模式
    0x02,   // 页寻址模式
    0xA1,   // 段重定义设置，0xA1正常，0xA0左右反置
    0xC8,   // 行扫描顺序，0xC8正常，0xC0上下反置
    0xDA,   // 设置COM引脚硬件配置
    0x12,   // 
    0x81,   // 设置对比度
    0xCF,   // 对比度值
    0xD9,   // 设置预充电周期
    0xF1,   // 
    0xDB,   // 设置VCOMH取消选择级别
    0x30,   // 
    0xA4,   // 全局显示开启
    0xA6,   // 设置正常显示
    0xAF    // 开启显示
};

/* ASCII字库，6x8点阵 */
static const uint8_t F6x8[][6] = {
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },   // sp
    { 0x00, 0x00, 0x00, 0x2f, 0x00, 0x00 },   // !
    { 0x00, 0x00, 0x07, 0x00, 0x07, 0x00 },   // "
    { 0x14, 0x7f, 0x14, 0x7f, 0x14, 0x00 },   // #
    { 0x24, 0x2a, 0x7f, 0x2a, 0x12, 0x00 },   // $
    { 0x23, 0x13, 0x08, 0x64, 0x62, 0x00 },   // %
    { 0x36, 0x49, 0x55, 0x22, 0x50, 0x00 },   // &
    { 0x00, 0x05, 0x03, 0x00, 0x00, 0x00 },   // '
    { 0x00, 0x1c, 0x22, 0x41, 0x00, 0x00 },   // (
    { 0x00, 0x41, 0x22, 0x1c, 0x00, 0x00 },   // )
    { 0x14, 0x08, 0x3E, 0x08, 0x14, 0x00 },   // *
    { 0x08, 0x08, 0x3E, 0x08, 0x08, 0x00 },   // +
    { 0x00, 0x00, 0x50, 0x30, 0x00, 0x00 },   // ,
    { 0x08, 0x08, 0x08, 0x08, 0x08, 0x00 },   // -
    { 0x00, 0x60, 0x60, 0x00, 0x00, 0x00 },   // .
    { 0x20, 0x10, 0x08, 0x04, 0x02, 0x00 },   // /
    { 0x3E, 0x51, 0x49, 0x45, 0x3E, 0x00 },   // 0
    { 0x00, 0x42, 0x7F, 0x40, 0x00, 0x00 },   // 1
    { 0x42, 0x61, 0x51, 0x49, 0x46, 0x00 },   // 2
    { 0x21, 0x41, 0x45, 0x4B, 0x31, 0x00 },   // 3
    { 0x18, 0x14, 0x12, 0x7F, 0x10, 0x00 },   // 4
    { 0x27, 0x45, 0x45, 0x45, 0x39, 0x00 },   // 5
    { 0x3C, 0x4A, 0x49, 0x49, 0x30, 0x00 },   // 6
    { 0x01, 0x71, 0x09, 0x05, 0x03, 0x00 },   // 7
    { 0x36, 0x49, 0x49, 0x49, 0x36, 0x00 },   // 8
    { 0x06, 0x49, 0x49, 0x29, 0x1E, 0x00 },   // 9
    { 0x00, 0x36, 0x36, 0x00, 0x00, 0x00 },   // :
    { 0x00, 0x56, 0x36, 0x00, 0x00, 0x00 },   // ;
    { 0x08, 0x14, 0x22, 0x41, 0x00, 0x00 },   // <
    { 0x14, 0x14, 0x14, 0x14, 0x14, 0x00 },   // =
    { 0x00, 0x41, 0x22, 0x14, 0x08, 0x00 },   // >
    { 0x02, 0x01, 0x51, 0x09, 0x06, 0x00 },   // ?
    { 0x32, 0x49, 0x59, 0x51, 0x3E, 0x00 },   // @
    { 0x7E, 0x11, 0x11, 0x11, 0x7E, 0x00 },   // A
    { 0x7F, 0x49, 0x49, 0x49, 0x36, 0x00 },   // B
    { 0x3E, 0x41, 0x41, 0x41, 0x22, 0x00 },   // C
    { 0x7F, 0x41, 0x41, 0x22, 0x1C, 0x00 },   // D
    { 0x7F, 0x49, 0x49, 0x49, 0x41, 0x00 },   // E
    { 0x7F, 0x09, 0x09, 0x09, 0x01, 0x00 },   // F
    { 0x3E, 0x41, 0x49, 0x49, 0x7A, 0x00 },   // G
    { 0x7F, 0x08, 0x08, 0x08, 0x7F, 0x00 },   // H
    { 0x00, 0x41, 0x7F, 0x41, 0x00, 0x00 },   // I
    { 0x20, 0x40, 0x41, 0x3F, 0x01, 0x00 },   // J
    { 0x7F, 0x08, 0x14, 0x22, 0x41, 0x00 },   // K
    { 0x7F, 0x40, 0x40, 0x40, 0x40, 0x00 },   // L
    { 0x7F, 0x02, 0x0C, 0x02, 0x7F, 0x00 },   // M
    { 0x7F, 0x04, 0x08, 0x10, 0x7F, 0x00 },   // N
    { 0x3E, 0x41, 0x41, 0x41, 0x3E, 0x00 },   // O
    { 0x7F, 0x09, 0x09, 0x09, 0x06, 0x00 },   // P
    { 0x3E, 0x41, 0x51, 0x21, 0x5E, 0x00 },   // Q
    { 0x7F, 0x09, 0x19, 0x29, 0x46, 0x00 },   // R
    { 0x46, 0x49, 0x49, 0x49, 0x31, 0x00 },   // S
    { 0x01, 0x01, 0x7F, 0x01, 0x01, 0x00 },   // T
    { 0x3F, 0x40, 0x40, 0x40, 0x3F, 0x00 },   // U
    { 0x1F, 0x20, 0x40, 0x20, 0x1F, 0x00 },   // V
    { 0x3F, 0x40, 0x38, 0x40, 0x3F, 0x00 },   // W
    { 0x63, 0x14, 0x08, 0x14, 0x63, 0x00 },   // X
    { 0x07, 0x08, 0x70, 0x08, 0x07, 0x00 },   // Y
    { 0x61, 0x51, 0x49, 0x45, 0x43, 0x00 },   // Z
    { 0x00, 0x7F, 0x41, 0x41, 0x00, 0x00 },   // [
    { 0x02, 0x04, 0x08, 0x10, 0x20, 0x00 },   // "\"
    { 0x00, 0x41, 0x41, 0x7F, 0x00, 0x00 },   // ]
    { 0x04, 0x02, 0x01, 0x02, 0x04, 0x00 },   // ^
    { 0x40, 0x40, 0x40, 0x40, 0x40, 0x00 },   // _
    { 0x00, 0x01, 0x02, 0x04, 0x00, 0x00 },   // `
    { 0x20, 0x54, 0x54, 0x54, 0x78, 0x00 },   // a
    { 0x7F, 0x48, 0x44, 0x44, 0x38, 0x00 },   // b
    { 0x38, 0x44, 0x44, 0x44, 0x20, 0x00 },   // c
    { 0x38, 0x44, 0x44, 0x48, 0x7F, 0x00 },   // d
    { 0x38, 0x54, 0x54, 0x54, 0x18, 0x00 },   // e
    { 0x08, 0x7E, 0x09, 0x01, 0x02, 0x00 },   // f
    { 0x0C, 0x52, 0x52, 0x52, 0x3E, 0x00 },   // g
    { 0x7F, 0x08, 0x04, 0x04, 0x78, 0x00 },   // h
    { 0x00, 0x44, 0x7D, 0x40, 0x00, 0x00 },   // i
    { 0x20, 0x40, 0x44, 0x3D, 0x00, 0x00 },   // j
    { 0x7F, 0x10, 0x28, 0x44, 0x00, 0x00 },   // k
    { 0x00, 0x41, 0x7F, 0x40, 0x00, 0x00 },   // l
    { 0x7C, 0x04, 0x18, 0x04, 0x78, 0x00 },   // m
    { 0x7C, 0x08, 0x04, 0x04, 0x78, 0x00 },   // n
    { 0x38, 0x44, 0x44, 0x44, 0x38, 0x00 },   // o
    { 0x7C, 0x14, 0x14, 0x14, 0x08, 0x00 },   // p
    { 0x08, 0x14, 0x14, 0x18, 0x7C, 0x00 },   // q
    { 0x7C, 0x08, 0x04, 0x04, 0x08, 0x00 },   // r
    { 0x48, 0x54, 0x54, 0x54, 0x20, 0x00 },   // s
    { 0x04, 0x3F, 0x44, 0x40, 0x20, 0x00 },   // t
    { 0x3C, 0x40, 0x40, 0x20, 0x7C, 0x00 },   // u
    { 0x1C, 0x20, 0x40, 0x20, 0x1C, 0x00 },   // v
    { 0x3C, 0x40, 0x30, 0x40, 0x3C, 0x00 },   // w
    { 0x44, 0x28, 0x10, 0x28, 0x44, 0x00 },   // x
    { 0x0C, 0x50, 0x50, 0x50, 0x3C, 0x00 },   // y
    { 0x44, 0x64, 0x54, 0x4C, 0x44, 0x00 },   // z
    { 0x00, 0x08, 0x36, 0x41, 0x00, 0x00 },   // {
    { 0x00, 0x00, 0x7F, 0x00, 0x00, 0x00 },   // |
    { 0x00, 0x41, 0x36, 0x08, 0x00, 0x00 },   // }
    { 0x02, 0x01, 0x02, 0x04, 0x02, 0x00 },   // ~
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }    // DEL
};

/**
  * @brief  OLED写命令
  * @param  cmd: 要写入的命令
  * @retval None
  */
void OLED_WriteCmd(uint8_t cmd)
{
    uint8_t temp[2];
    temp[0] = OLED_I2C_CMD;    // 0x00，写命令
    temp[1] = cmd;
    HAL_I2C_Master_Transmit(&hi2c1, OLED_I2C_ADDR, temp, 2, 0xFF);
}

/**
  * @brief  OLED写数据
  * @param  data: 要写入的数据
  * @retval None
  */
void OLED_WriteData(uint8_t data)
{
    uint8_t temp[2];
    temp[0] = OLED_I2C_DATA;   // 0x40，写数据
    temp[1] = data;
    HAL_I2C_Master_Transmit(&hi2c1, OLED_I2C_ADDR, temp, 2, 0xFF);
}

/**
  * @brief  OLED初始化
  * @param  None
  * @retval None
  */
void OLED_Init(void)
{
    HAL_Delay(100);  // 等待OLED上电稳定
    
    /* 发送初始化命令序列 */
    for(uint8_t i = 0; i < sizeof(OLED_Init_CMD); i++)
    {
        OLED_WriteCmd(OLED_Init_CMD[i]);
    }
    
    /* 清屏 */
    OLED_Clear();
    
    /* 开启显示 */
    OLED_Display_On();
}

/**
  * @brief  OLED清屏
  * @param  None
  * @retval None
  */
void OLED_Clear(void)
{
    for(uint8_t i = 0; i < OLED_PAGE; i++)
    {
        OLED_WriteCmd(0xB0 + i);   // 设置页地址
        OLED_WriteCmd(0x00);       // 设置列地址低4位
        OLED_WriteCmd(0x10);       // 设置列地址高4位
        
        for(uint8_t j = 0; j < OLED_WIDTH; j++)
        {
            OLED_WriteData(0x00);  // 清除所有像素
        }
    }
}

/**
  * @brief  开启OLED显示
  * @param  None
  * @retval None
  */
void OLED_Display_On(void)
{
    OLED_WriteCmd(OLED_CMD_DISPLAY_ON);
}

/**
  * @brief  关闭OLED显示
  * @param  None
  * @retval None
  */
void OLED_Display_Off(void)
{
    OLED_WriteCmd(OLED_CMD_DISPLAY_OFF);
}

/**
  * @brief  设置OLED显示位置
  * @param  x: 列坐标，范围0~127
  * @param  y: 页坐标，范围0~7
  * @retval None
  */
void OLED_SetPosition(uint8_t x, uint8_t y)
{
    OLED_WriteCmd(0xB0 + y);                   // 设置页地址
    OLED_WriteCmd(0x00 + (x & 0x0F));         // 设置列地址低4位
    OLED_WriteCmd(0x10 + ((x >> 4) & 0x0F));  // 设置列地址高4位
}

/**
  * @brief  OLED显示一个字符
  * @param  x: 列坐标，范围0~127
  * @param  y: 页坐标，范围0~7
  * @param  chr: 要显示的字符
  * @retval None
  */
void OLED_ShowChar(uint8_t x, uint8_t y, char chr)
{
    uint8_t c = 0;
    c = chr - ' ';    // 得到字符的偏移量
    
    if(x > OLED_WIDTH - 6) { x = 0; y = y + 1; }  // 自动换行
    if(y > OLED_PAGE - 1) { y = 0; }              // 页面重置
    
    OLED_SetPosition(x, y);
    
    // 显示一个字符
    for(uint8_t i = 0; i < 6; i++)
    {
        OLED_WriteData(F6x8[c][i]);
    }
}

/**
  * @brief  OLED显示字符串
  * @param  x: 列坐标，范围0~127
  * @param  y: 页坐标，范围0~7
  * @param  str: 要显示的字符串
  * @retval None
  */
void OLED_ShowString(uint8_t x, uint8_t y, const char *str)
{
    uint8_t j = 0;
    while (str[j] != '\0')
    {
        OLED_ShowChar(x, y, str[j]);
        x += 6;
        if(x > OLED_WIDTH - 6)
        {
            x = 0;
            y++;
        }
        if(y > OLED_PAGE - 1) { y = 0; }  // 当y超出范围时重置为0
        j++;
    }
}

/**
  * @brief  设置OLED显示对比度
  * @param  contrast: 对比度值，范围0x00-0xFF
  *         0x00最暗，0xFF最亮，默认值0xCF
  * @retval None
  */
void OLED_SetContrast(uint8_t contrast)
{
    OLED_WriteCmd(OLED_CMD_SET_CONTRAST);  // 设置对比度命令
    OLED_WriteCmd(contrast);               // 对比度值
} 
