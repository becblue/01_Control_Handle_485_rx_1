# STM32F103 
这是一个基于STM32开发板开发的MODBUS从站控制器项目

## 1. 项目概述
本项目是一个基于STM32F103C8T6的Modbus RTU通讯系统的B站开发项目。该系统网络拓扑采用主从架构，A为主站，B为从站。A站可主动发起通信；B站只作应答
B站通过RS485接收A站发送的KEY1、KEY2、KEY3按键状态保存至寄存器，同时解析寄存器数据，用来驱动LED1、LED2、LED3的亮灭。同时因为主从架构，B站同样需要完成数据采集，并使用ADC轮询或DMA方式读取B站LED1、LED2、LED3以及KEY1,KEY2状态，打包后发送至A站。
发送间隔时间100MS.同时B站需要将LED1、LED2、LED3、KEY1、KEY2状态显示在OLED显示屏上。

## 2. 硬件配置

### 2.1 OLED显示屏 (I2C)
- 参考文献：OLED显示屏规格书，文档路径：.\STM32\ex07_Control_Handle_485_4L_rx\Doc野火0.96寸_IIC_OLED模块规格手册_20240419 
- 通信接口：I2C1
- 引脚配置：
  - SCL: PB6
  - SDA: PB7
- 分辨率：128x64
- 地址：0x78
- 显示控制器：SSD1306
- 字库配置：
  - ASCII字库：6x8点阵
  - 字符范围：ASCII 0x20-0x7E
  - 字体数据结构：
    ```c
    // 6x8字体库数组，每个字符6字节
    const uint8_t F6x8[][6] = {
         { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },   // sp
    { 0x00, 0x00, 0x00, 0x2f, 0x00, 0x00 },   // !
    { 0x00, 0x00, 0x07, 0x00, 0x07, 0x00 },   // "
    { 0x14, 0x7f, 0x14, 0x7f, 0x14, 0x00 },   // #
    { 0x24, 0x2a, 0x7f, 0x2a, 0x12, 0x00 },   // $
    { 0x23, 0x13, 0x08, 0x64, 0x62, 0x00 },   // %
    { 0x36, 0x49, 0x55, 0x22, 0x50, 0x00 },   // &
    { 0x00, 0x05, 0x03, 0x00, 0x00, 0x00 },   // '
    { 0x00, 0x1c, 0x22, 0x41, 0x00, 0x00 },   // (
    { 0x00, 0x41, 0x22, 0x1c, 0x00, 0x00 },   // )
    { 0x14, 0x08, 0x3E, 0x08, 0x14, 0x00 },   // *
    { 0x08, 0x08, 0x3E, 0x08, 0x08, 0x00 },   // +
    { 0x00, 0x00, 0x50, 0x30, 0x00, 0x00 },   // ,
    { 0x08, 0x08, 0x08, 0x08, 0x08, 0x00 },   // -
    { 0x00, 0x60, 0x60, 0x00, 0x00, 0x00 },   // .
    { 0x20, 0x10, 0x08, 0x04, 0x02, 0x00 },   // /
    { 0x3E, 0x51, 0x49, 0x45, 0x3E, 0x00 },   // 0
    { 0x00, 0x42, 0x7F, 0x40, 0x00, 0x00 },   // 1
    { 0x42, 0x61, 0x51, 0x49, 0x46, 0x00 },   // 2
    { 0x21, 0x41, 0x45, 0x4B, 0x31, 0x00 },   // 3
    { 0x18, 0x14, 0x12, 0x7F, 0x10, 0x00 },   // 4
    { 0x27, 0x45, 0x45, 0x45, 0x39, 0x00 },   // 5
    { 0x3C, 0x4A, 0x49, 0x49, 0x30, 0x00 },   // 6
    { 0x01, 0x71, 0x09, 0x05, 0x03, 0x00 },   // 7
    { 0x36, 0x49, 0x49, 0x49, 0x36, 0x00 },   // 8
    { 0x06, 0x49, 0x49, 0x29, 0x1E, 0x00 },   // 9
    { 0x00, 0x36, 0x36, 0x00, 0x00, 0x00 },   // :
    { 0x00, 0x56, 0x36, 0x00, 0x00, 0x00 },   // ;
    { 0x08, 0x14, 0x22, 0x41, 0x00, 0x00 },   // <
    { 0x14, 0x14, 0x14, 0x14, 0x14, 0x00 },   // =
    { 0x00, 0x41, 0x22, 0x14, 0x08, 0x00 },   // >
    { 0x02, 0x01, 0x51, 0x09, 0x06, 0x00 },   // ?
    { 0x32, 0x49, 0x59, 0x51, 0x3E, 0x00 },   // @
    { 0x7E, 0x11, 0x11, 0x11, 0x7E, 0x00 },   // A
    { 0x7F, 0x49, 0x49, 0x49, 0x36, 0x00 },   // B
    { 0x3E, 0x41, 0x41, 0x41, 0x22, 0x00 },   // C
    { 0x7F, 0x41, 0x41, 0x22, 0x1C, 0x00 },   // D
    { 0x7F, 0x49, 0x49, 0x49, 0x41, 0x00 },   // E
    { 0x7F, 0x09, 0x09, 0x09, 0x01, 0x00 },   // F
    { 0x3E, 0x41, 0x49, 0x49, 0x7A, 0x00 },   // G
    { 0x7F, 0x08, 0x08, 0x08, 0x7F, 0x00 },   // H
    { 0x00, 0x41, 0x7F, 0x41, 0x00, 0x00 },   // I
    { 0x20, 0x40, 0x41, 0x3F, 0x01, 0x00 },   // J
    { 0x7F, 0x08, 0x14, 0x22, 0x41, 0x00 },   // K
    { 0x7F, 0x40, 0x40, 0x40, 0x40, 0x00 },   // L
    { 0x7F, 0x02, 0x0C, 0x02, 0x7F, 0x00 },   // M
    { 0x7F, 0x04, 0x08, 0x10, 0x7F, 0x00 },   // N
    { 0x3E, 0x41, 0x41, 0x41, 0x3E, 0x00 },   // O
    { 0x7F, 0x09, 0x09, 0x09, 0x06, 0x00 },   // P
    { 0x3E, 0x41, 0x51, 0x21, 0x5E, 0x00 },   // Q
    { 0x7F, 0x09, 0x19, 0x29, 0x46, 0x00 },   // R
    { 0x46, 0x49, 0x49, 0x49, 0x31, 0x00 },   // S
    { 0x01, 0x01, 0x7F, 0x01, 0x01, 0x00 },   // T
    { 0x3F, 0x40, 0x40, 0x40, 0x3F, 0x00 },   // U
    { 0x1F, 0x20, 0x40, 0x20, 0x1F, 0x00 },   // V
    { 0x3F, 0x40, 0x38, 0x40, 0x3F, 0x00 },   // W
    { 0x63, 0x14, 0x08, 0x14, 0x63, 0x00 },   // X
    { 0x07, 0x08, 0x70, 0x08, 0x07, 0x00 },   // Y
    { 0x61, 0x51, 0x49, 0x45, 0x43, 0x00 },   // Z
    { 0x00, 0x7F, 0x41, 0x41, 0x00, 0x00 },   // [
    { 0x02, 0x04, 0x08, 0x10, 0x20, 0x00 },   // "\"
    { 0x00, 0x41, 0x41, 0x7F, 0x00, 0x00 },   // ]
    { 0x04, 0x02, 0x01, 0x02, 0x04, 0x00 },   // ^
    { 0x40, 0x40, 0x40, 0x40, 0x40, 0x00 },   // _
    { 0x00, 0x01, 0x02, 0x04, 0x00, 0x00 },   // '
    { 0x20, 0x54, 0x54, 0x54, 0x78, 0x00 },   // a
    { 0x7F, 0x48, 0x44, 0x44, 0x38, 0x00 },   // b
    { 0x38, 0x44, 0x44, 0x44, 0x20, 0x00 },   // c
    { 0x38, 0x44, 0x44, 0x48, 0x7F, 0x00 },   // d
    { 0x38, 0x54, 0x54, 0x54, 0x18, 0x00 },   // e
    { 0x08, 0x7E, 0x09, 0x01, 0x02, 0x00 },   // f
    { 0x0C, 0x52, 0x52, 0x52, 0x3E, 0x00 },   // g
    { 0x7F, 0x08, 0x04, 0x04, 0x78, 0x00 },   // h
    { 0x00, 0x44, 0x7D, 0x40, 0x00, 0x00 },   // i
    { 0x20, 0x40, 0x44, 0x3D, 0x00, 0x00 },   // j
    { 0x7F, 0x10, 0x28, 0x44, 0x00, 0x00 },   // k
    { 0x00, 0x41, 0x7F, 0x40, 0x00, 0x00 },   // l
    { 0x7C, 0x04, 0x18, 0x04, 0x78, 0x00 },   // m
    { 0x7C, 0x08, 0x04, 0x04, 0x78, 0x00 },   // n
    { 0x38, 0x44, 0x44, 0x44, 0x38, 0x00 },   // o
    { 0x7C, 0x14, 0x14, 0x14, 0x08, 0x00 },   // p
    { 0x08, 0x14, 0x14, 0x18, 0x7C, 0x00 },   // q
    { 0x7C, 0x08, 0x04, 0x04, 0x08, 0x00 },   // r
    { 0x48, 0x54, 0x54, 0x54, 0x20, 0x00 },   // s
    { 0x04, 0x3F, 0x44, 0x40, 0x20, 0x00 },   // t
    { 0x3C, 0x40, 0x40, 0x20, 0x7C, 0x00 },   // u
    { 0x1C, 0x20, 0x40, 0x20, 0x1C, 0x00 },   // v
    { 0x3C, 0x40, 0x30, 0x40, 0x3C, 0x00 },   // w
    { 0x44, 0x28, 0x10, 0x28, 0x44, 0x00 },   // x
    { 0x0C, 0x50, 0x50, 0x50, 0x3C, 0x00 },   // y
    { 0x44, 0x64, 0x54, 0x4C, 0x44, 0x00 },   // z
    { 0x00, 0x08, 0x36, 0x41, 0x00, 0x00 },   // {
    { 0x00, 0x00, 0x7F, 0x00, 0x00, 0x00 },   // |
    { 0x00, 0x41, 0x36, 0x08, 0x00, 0x00 },   // }
    { 0x10, 0x08, 0x08, 0x10, 0x08, 0x00 },   // ~
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }    // DEL
    };
    ```
  - 字体特点：
    - 每个字符6x8像素
    - 每字节代表一列点阵
    - 1表示点亮，0表示熄灭
    - 支持95个可打印字符
  - 显示方式：
    - 垂直扫描
    - 逐列显示
    - MSB在上，LSB在下
  - 字体效果：
    - 清晰可辨
    - 适合小尺寸显示
    - 支持基本符号
- 显示布局：
  - 第1行（0-7像素）：时间和CPU使用率
  - 第2行（16-23像素）：按键状态
  - 第3行（24-31像素）：LED状态
  - 第4行（32-39像素）：通信状态
  - 第5行（40-47像素）：错误计数
  - 第6行（48-55像素）：公司信息
- 显示特性：
  - 支持双缓冲
  - 脏区域刷新
  - 动画效果
  - 局部更新

### 2.2 RS485接口 (UART3)
- 通信接口：USART3
- 引脚配置：
  - TX: PB11
  - RX: PB10
  - DE/RE: PB8 (方向控制，高电平发送/低电平接收)
- 芯片型号：SIT3088E
- 电气特性：
  - 工作电压：3.3V
  - 差分电压：>2V
- 接线说明：
  - A+: 485差分信号正端
  - B-: 485差分信号负端
  - GND: 信号地
- 终端电阻：
  - 120Ω (在总线两端)
- 通信距离：最大1200米
- 通信参数：
  - 波特率：115200
  - 数据位：8
  - 停止位：1
  - 校验位：无
  - 通信模式：半双工
  - 总线特性：
    - 支持多点通信
    - 抗干扰能力强
    - 传输距离远

### 2.3 调试串口 (UART1)
- 通信接口：USART1
- 引脚配置：
  - TX: PA9
  - RX: PA10
- 通信参数：同RS485

### 2.4 LED指示灯
- LED_R: PA1
- LED_G: PA2
- LED_B: PA3

## 3. 软件架构

### 3.1 通信协议
#### RS485数据帧格式 (8字节)
```
| 字段     | 帧头  | 目标地址 | 源地址  | 命令字 | 长度 | 数据 | 校验和 | 帧尾  |
|---------|-------|---------|---------|--------|------|------|--------|-------|
| 长度(字节)| 1     | 1       | 1       | 1      | 1    | 1    | 1      | 1     |
| 值      | 0xAA  | ADDR    | ADDR    | CMD    | LEN  | DATA | SUM    | 0x55  |
```

### 命令定义
1. 按键状态命令（0x10）
   - 数据格式：1字节按键状态
   - bit0-2：对应KEY1-3状态
   - bit3-7：保留

2. 状态上报命令（0x20）
   - 数据格式：1字节状态
   - bit0-2：对应KEY1-3状态
   - bit3-7：保留

## 代码结构
### 核心文件
1. 通信模块
   - comm.h/comm.c：通信协议实现
   - 包含数据包解析和处理

2. 显示模块
   - oled.h/oled.c：OLED驱动实现
   - 包含双缓冲和脏区域管理

3. 主程序
   - main.c：主循环和初始化
   - 系统任务调度

## 关键技术实现
1. 双缓冲显示
   - 使用两个显示缓冲区
   - 避免画面撕裂
   - 提高显示效率

2. 通信管理
   - 中断接收
   - 帧校验
   - 超时检测
   - 错误统计

3. 系统监控
   - CPU使用率检测
   - 通信状态监控
   - 错误计数管理

## 性能指标
- 显示刷新率：60Hz
- 通信波特率：115200
- 响应时间：<10ms
- CPU占用率：实时显示

## 注意事项
1. 硬件连接
   - I2C需要外部上拉电阻（4.7K）
   - 485需要合适的终端电阻
   - 电源要求稳定5V供电

2. 软件配置
   - 需要正确配置通信波特率
   - 注意通信超时设置
   - 关注CPU使用率

## 维护记录
- 版本：V1.0.0
- 更新时间：2024-xx-xx
- 主要更新：
  * 实现基础通信功能
  * 完成显示功能
  * 添加系统监控
  * 优化显示效果

## 后续计划
1. 功能完善
   - 添加更多显示内容
   - 优化通信协议
   - 增加错误处理

2. 性能优化
   - 降低CPU占用
   - 提高通信效率
   - 优化显示刷新

## 参考资料
1. STM32F103数据手册
2. OLED显示屏规格书
3. MAX485数据手册
4. HAL库使用手册

